# ============================================
# .htaccess - RR Engenharia (Apache/GoDaddy)
# Replica as regras do server/index.ts no Apache
# ============================================

# Ativar RewriteEngine para SPA routing
RewriteEngine On

# --------------------------------------------
# GZIP Compression
# --------------------------------------------
<IfModule mod_deflate.c>
  AddOutputFilterByType DEFLATE text/html
  AddOutputFilterByType DEFLATE text/css
  AddOutputFilterByType DEFLATE text/javascript
  AddOutputFilterByType DEFLATE application/javascript
  AddOutputFilterByType DEFLATE application/json
  AddOutputFilterByType DEFLATE image/svg+xml
  AddOutputFilterByType DEFLATE application/xml
  AddOutputFilterByType DEFLATE text/xml
</IfModule>

# --------------------------------------------
# Cache Control Headers
# --------------------------------------------
<IfModule mod_headers.c>
  # HTML - nunca cachear (sempre revalidar)
  <FilesMatch "\.html$">
    Header set Cache-Control "no-cache"
  </FilesMatch>

  # Outros arquivos estaticos - cache 1 hora
  <FilesMatch "\.(ico|svg|png|jpg|jpeg|webp|gif|woff|woff2|ttf|eot|json|xml|txt|webmanifest)$">
    Header set Cache-Control "public, max-age=3600"
  </FilesMatch>

  # Assets com hash do Vite (JS/CSS) - cache 1 ano, imutavel
  SetEnvIf Request_URI "^/assets/" VITE_ASSET
  Header set Cache-Control "public, max-age=31536000, immutable" env=VITE_ASSET
</IfModule>

# Fallback via mod_expires caso mod_headers nao esteja disponivel
<IfModule mod_expires.c>
  ExpiresActive On
  ExpiresByType text/html "access plus 0 seconds"
  ExpiresByType text/css "access plus 1 year"
  ExpiresByType application/javascript "access plus 1 year"
  ExpiresByType image/svg+xml "access plus 1 hour"
  ExpiresByType image/png "access plus 1 hour"
  ExpiresByType image/jpeg "access plus 1 hour"
  ExpiresByType image/webp "access plus 1 hour"
  ExpiresByType font/woff2 "access plus 1 year"
  ExpiresByType application/json "access plus 1 hour"
</IfModule>

# --------------------------------------------
# SPA Routing (catch-all para index.html)
# Equivale ao app.get("*") do Express
# --------------------------------------------

# Nao reescrever se o arquivo ou diretorio existe fisicamente
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d

# Redirecionar tudo para index.html (client-side routing via Wouter)
RewriteRule ^ index.html [L]

# --------------------------------------------
# Seguranca basica
# --------------------------------------------

# Impedir acesso a arquivos ocultos (exceto .htaccess)
<FilesMatch "^\.(?!htaccess)">
  <IfModule mod_authz_core.c>
    Require all denied
  </IfModule>
</FilesMatch>

# Desabilitar listagem de diretorio
Options -Indexes

# Impedir que o Apache exiba versao no header
<IfModule mod_headers.c>
  Header unset X-Powered-By
  Header set X-Content-Type-Options "nosniff"
  Header set X-Frame-Options "SAMEORIGIN"
  Header set Referrer-Policy "strict-origin-when-cross-origin"
</IfModule>
